"use strict";angular.module("civicPandaApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/user-input",{templateUrl:"views/input.html",controller:"InputCtrl"}).when("/results",{templateUrl:"views/results.html",controller:"ResultsCtrl"}).otherwise({redirectTo:"/user-input"})}]),angular.module("civicPandaApp").controller("MainCtrl",["$scope","$location","$timeout","Permits","Filters","Processes","User","State",function(a,b,c,d){function e(){c(function(){a.blurImage=!0},1e3)}d.init(),a.blurImage=!1,e()}]),angular.module("civicPandaApp").service("User",["$location","$rootScope","State",function(a,b,c){function d(){c.overwriteState(f),b.$broadcast("logIn")}function e(a){var d=a||0;c.overwriteState(g[d]),b.$broadcast("logOut")}var f={name:"",properties:[{id:0,name:"Your new project",saved:!1,selections:{categories:[],types:[],subtypes:[],changes:[],progresses:[],zones:[]}}]},g=[{name:"Phil",properties:[{id:0,name:"Philâ€™s Pizza",saved:!0,selections:{types:[1],categories:[1],changes:[0],subtypes:[1],progresses:[],zones:[]}},{id:1,name:"My house",saved:!0,selections:{types:[3],categories:[1],changes:[1],subtypes:[],progresses:[],zones:[]}}]}];return{logIn:e,logOut:d}}]),angular.module("civicPandaApp").service("Permits",["$http","$q",function(a,b){function c(){var c=b.defer();return a.get("data/permits.json").success(function(a){j=a,c.resolve()}).error(function(){c.reject()}),c.promise}function d(){return j}function e(a,b){if(0===b.length)return null;for(var c=0;c<b.length;c++)if(a.categories.indexOf(b[c])>-1)return!0;return!1}function f(a,b){for(var c=0;c<b.length;c++)if(a.types.indexOf(b[c])>-1)return!0;return!1}function g(a,b){for(var c=0;c<b.length;c++)if(a.subtypes.indexOf(b[c])>-1)return!0;return!1}function h(a,b){for(var c=0;c<b.length;c++)if(a.changes.indexOf(b[c])>-1)return!0;return!1}function i(a){for(var b,c,d,i,k,l,m,n,o=[],p=0;p<j.length;p++)b=j[p],d=g(b,a.subtypes),i=f(b,a.types),k=e(b,a.categories),l=0!==a.subtypes.length,m=0!==a.types.length,n=0!==a.categories.length,l||m||!n||(c=!d&&!i&&k),!l&&m&&n&&(c=!d&&i&&k),l&&m&&n&&(c=d&&i&&k),h(b,a.changes)===!0&&(c=!0),c===!0&&o.push(b);return o}var j=[];return c(),{init:c,getAll:d,getFiltered:i}}]),angular.module("civicPandaApp").service("Filters",["$http","$q",function(a,b){function c(){var c=b.defer();return a.get("data/filters.json").success(function(a){e=a,f=e.categories,g=e.types,h=e.subtypes,i=e.changes,c.resolve()}).error(function(){c.reject()}),c.promise}function d(a){var d=b.defer();return void 0===e?c().then(function(){d.resolve(e[a])}):d.resolve(e[a]),d.promise}var e,f,g,h,i;return{categories:f,types:g,subtypes:h,changes:i,getList:d}}]),angular.module("civicPandaApp").service("State",["$rootScope","Permits",function(a,b){function c(b){p=0,r=angular.copy(b),j(),a.$broadcast("stateChange")}function d(){for(var a=[],b=0;b<r.properties.length;b++)a.push(r.properties[b]);return a}function e(){return r.properties[p].selections}function f(){return r.properties[p]}function g(b){p=b<r.properties.length?b:0,a.$broadcast("stateChange")}function h(a,b){r.properties[p].selections[a]=[b],j()}function i(a,b){var c=e()[a].indexOf(b);0>c?r.properties[p].selections[a].push(b):r.properties[p].selections[a].splice(c,1),j()}function j(){var c=b.getFiltered(e());l(c),k(c),a.$broadcast("summationUpdated")}function k(a){s=0;for(var b=0;b<a.length;b++)s+=a[b].cost}function l(a){u=0;for(var b=0;b<a.length;b++)u+=a[b].minDuration;t=0;for(var b=0;b<a.length;b++)t+=a[b].maxDuration}function m(){return{cost:s,maxDuration:t,minDuration:u}}function n(){return r.name}function o(){return console.log(r),""===r.name}var p=0,q=0,r={name:"",properties:[{id:0,name:"Your new project",saved:!1,selections:{categories:[],types:[],subtypes:[],changes:[],progresses:[],zones:[]}}]},s=0,t=0,u=0;return{overwriteState:c,properties:d,property:f,selection:e,setProperty:g,toggleSelection:i,makeSelection:h,getPermitsInfo:m,getUsername:n,isLoggedIn:o,currentStep:q}}]),angular.module("civicPandaApp").service("Processes",["$http","$q",function(a,b){function c(){var c=b.defer();return a.get("data/processes.json").success(function(a){e=a,c.resolve()}).error(function(){c.reject()}),c.promise}function d(a){for(var b=0;b<e.length;b++)if(e[b].id===a)return e[b]}var e=[];return c(),{init:c,get:d}}]),angular.module("civicPandaApp").controller("InputCtrl",["$scope","$location","$routeParams","State","Filters",function(a,b,c,d,e){a.selection=d.selection(),a.$on("stateChange",function(){a.selection=d.selection(),a.currentStep=0}),a.toggle=d.toggleSelection,a.select=d.makeSelection,e.getList("types").then(function(b){a.types=b}),e.getList("subtypes").then(function(b){a.subtypes=b}),e.getList("changes").then(function(b){a.changes=b});var f=["What are you making","Your business information","Where are you located"],g=["views/input_one.html","views/input_two.html","views/input_three.html"];a.steps=[{id:0,display:"1",name:f[0],type:"categories",output:"I'm making a business",form:g[0]},{id:1,display:"2",name:f[1],type:"types",output:"I'm opening a restaurant",form:g[1]},{id:2,display:"3",name:f[2],type:"zones",output:"",form:g[2]}],a.currentStep=d.currentStep,a.setStep=function(b){a.currentStep=b},a.allowNextStep=function(b){return a.selection[b].length>0},a.nextStep=function(){a.currentStep<a.steps.length-1?a.currentStep++:b.path("results")},a.lastStep=function(){a.currentStep>0&&a.currentStep--},a.isSelected=function(b,c){return a.selection[b].indexOf(c)>-1}}]),angular.module("civicPandaApp").controller("ResultsCtrl",["$scope","Permits","Processes","User","State",function(a,b,c,d,e){function f(){b.init().then(function(){var d=e.selection();a.permits=b.getFiltered(d),c.init().then(function(){i(),m(),g()})})}function g(){if(a.groups=[],a.isLoggedIn===!0){var b=[];if(a.processSummary.now>0)for(var c=0;c<a.permits.length;c++){var d=a.permits[c];d.process.process[0].completed===!1&&d.pending!==!0&&b.push(d)}b.length>0&&(a.groups.push({name:"Now",permits:b}),console.log(a.groups));var e=[];if(a.processSummary.pending>0)for(var c=0;c<a.permits.length;c++){var d=a.permits[c];l(d.process.process)&&e.push(d)}e.length>0&&a.groups.push({name:"Pending",permits:e});var f=[];if(a.processSummary.done>0)for(var c=0;c<a.permits.length;c++){var d=a.permits[c];d.process.process[3].completed===!0&&f.push(d)}e.length>0&&a.groups.push({name:"Done",permits:f})}else a.groups.push({name:null,permits:a.permits})}function h(){for(var b={process:[{id:1,name:"Application",completed:!1,pending:!1},{id:2,name:"Work approval",completed:!1,pending:!1},{id:3,name:"In progress",completed:!1,pending:!1},{id:4,name:"Final approval",completed:!1,pending:!1}]},c=0;c<a.permits.length;c++){var d=a.permits[c];d.process=b,d.process&&(d.process.process=j(d.process.process)),d.newPermit=!0}}function i(){if(a.isLoggedIn===!1)return void h();for(var b=0;b<a.permits.length;b++){var d=a.permits[b],e=c.get(d.id);e&&(e.process=j(e.process)),d.process=e}}function j(a){var b=a;return b[0].completed===!1&&(b[0].web={name:"Start",linke:"www.cityofboston.gov/isd/building/permits.asp"}),b[1].completed===!1&&b[0].completed===!0&&(b[0].web=null,b[1].web={name:"Start",link:"www.cityofboston.gov/isd/building/permits.asp"}),b[2].completed===!1&&b[1].completed===!0&&b[0].completed===!0&&(b[0].web=null,b[1].web=null,b[2].web={name:"Start",link:"www.cityofboston.gov/isd/building/permits.asp"}),b}function k(a){for(var b=0,c=0;c<a.length;c++)a[c].completed===!0&&b++;return 3===b}function l(a){for(var b=0,c=0;c<a.length;c++)a[c].pending===!0&&b++;return b>0}function m(){for(var b=0,c=0,d=0;d<a.permits.length;d++){var e=a.permits[d],f=e.process.process;k&&f[3].completed===!0&&b++,l(f)&&c++}var g=a.permits.length;a.processSummary={done:b,pending:c,outstanding:g-b,now:g-b-c,total:g}}a.permits=[],a.processSummary={},f(),a.isLoggedIn=!1,a.groups=[],a.$on("stateChange",function(){a.isLoggedIn=!0,f()})}]),angular.module("civicPandaApp").controller("OverviewCtrl",["$scope","$rootScope","$location","User","State",function(a,b,c,d,e){function f(){var b=e.properties();a.projects=[];for(var c=0;c<b.length;c++)b[c].id!==a.project.id&&a.projects.push(b[c]);a.secondProject=a.projects.length>0?a.projects[0]:{}}d.logOut(),a.logIn=d.logIn,a.logOut=d.logOut,a.getUsername=e.getUsername,a.project=e.property(),a.projectDetails=e.getPermitsInfo(),f(),a.setSecondProject=function(){a.project=a.secondProject,e.setProperty(a.project.id),f()},a.$on("summationUpdated",function(){a.projectDetails=e.getPermitsInfo()}),a.$on("stateChange",function(){a.project=e.property(),a.projectDetails=e.getPermitsInfo(),f(),c.path(0===a.getUsername().length?"user-input":"results")})}]),angular.module("civicPandaApp").filter("daysOut",function(){return function(a,b){var c=b||"MMM Do 'YY";return moment().add(a,"days").format(c)}});